<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
  <title>Fizzy Zhang</title>
  <link rel="shortcut icon" href="/images/favicon.ico"> 
<link rel="stylesheet" href="/css/style.css">
 
<script src="/js/jquery.js"></script>
 
<script src="/js/search.js"></script>

<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <article class="article-container">
  <section class="header-container">
  <a class="header-title" href="/">
    <svg t="1693387181307" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4053" width="20" height="20">
      <path d="M946.5 505L560.1 118.8l-25.9-25.9c-12.3-12.2-32.1-12.2-44.4 0L77.5 505c-12.3 12.3-18.9 28.6-18.8 46 0.4 35.2 29.7 63.3 64.9 63.3h42.5V940h691.8V614.3h43.4c17.1 0 33.2-6.7 45.3-18.8 12.1-12.1 18.7-28.2 18.7-45.3 0-17-6.7-33.1-18.8-45.2zM568 868H456V664h112v204z m217.9-325.7V868H632V640c0-22.1-17.9-40-40-40H432c-22.1 0-40 17.9-40 40v228H238.1V542.3h-96l370-369.7 23.1 23.1L882 542.3h-96.1z" p-id="4054" fill="#515151"></path>
    </svg>
    <span>Fizzy Zhang</span>
  </a>
</section>
  <section class="article-body">
    <div class="post-toc">
      <h3>本文目录</h3>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-text">概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE"><span class="toc-text">1. 创建项目</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E5%8C%85%E7%AE%A1%E7%90%86-pnpm"><span class="toc-text">1.1 包管理 pnpm</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E5%9B%BD%E5%86%85%E9%95%9C%E5%83%8F"><span class="toc-text">1.2 国内镜像</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-webpack-%E6%89%93%E5%8C%85%E9%85%8D%E7%BD%AE"><span class="toc-text">2. webpack 打包配置</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E4%BD%BF%E7%94%A8-CSS"><span class="toc-text">3. 使用 CSS</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-CSS-Module"><span class="toc-text">3.1 CSS Module</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-PostCSS"><span class="toc-text">3.2 PostCSS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E5%88%86%E7%A6%BB%E6%89%93%E5%8C%85CSS"><span class="toc-text">3.3 分离打包CSS</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E4%BD%BF%E7%94%A8-React-%E5%92%8C-TS"><span class="toc-text">4. 使用 React 和 TS</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0-TS-%E6%94%AF%E6%8C%81"><span class="toc-text">增加 TS 支持</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E8%A7%84%E8%8C%83%E7%BC%96%E7%A0%81-Lint"><span class="toc-text">5. 规范编码 Lint</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-ESLint"><span class="toc-text">5.1 ESLint</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-StyleLint"><span class="toc-text">5.2 StyleLint</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-%E4%BD%BF%E7%94%A8-Prettier-%E6%A0%BC%E5%BC%8F%E5%8C%96%E9%A1%B9%E7%9B%AE"><span class="toc-text">6. 使用 Prettier 格式化项目</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B7%AF%E7%94%B1"><span class="toc-text">7. 客户端路由</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-%E5%BC%80%E5%8F%91%E7%94%9F%E4%BA%A7%E5%88%86%E7%A6%BB"><span class="toc-text">8. 开发生产分离</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-text">8.1 开发环境配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-1-%E4%BD%BF%E7%94%A8-source-map"><span class="toc-text">8.1.1 使用 source-map</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-2-%E6%9C%AC%E5%9C%B0%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-text">8.1.2 本地代理服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-3-%E2%80%9C%E7%83%AD%E6%9B%B4%E6%96%B0%E2%80%9D"><span class="toc-text">8.1.3 “热更新”</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-text">8.2 生产环境配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-1-%E5%8E%8B%E7%BC%A9%E4%BA%A7%E7%89%A9"><span class="toc-text">8.2.1 压缩产物</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-2-%E7%A7%BB%E9%99%A4%E8%B0%83%E8%AF%95%E8%BE%93%E5%87%BA%E8%AF%AD%E5%8F%A5"><span class="toc-text">8.2.2 移除调试输出语句</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-3-%E5%85%B6%E4%BB%96%E4%BC%98%E5%8C%96%E9%85%8D%E7%BD%AE"><span class="toc-text">8.3 其他优化配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-1-%E9%85%8D%E7%BD%AE%E5%90%88%E5%B9%B6"><span class="toc-text">8.3.1 配置合并</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-2-%E5%A4%96%E9%83%A8-CDN-%E5%8A%A0%E8%BD%BD"><span class="toc-text">8.3.2 外部 CDN 加载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-3-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%89%93%E5%8C%85"><span class="toc-text">8.3.3 多线程打包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-4-treeShaking"><span class="toc-text">8.3.4 treeShaking</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-%E6%89%A9%E5%B1%95"><span class="toc-text">9. 扩展</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1-antd"><span class="toc-text">9.1 antd</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-2-redux"><span class="toc-text">9.2 redux</span></a></li></ol></li></ol>
    </div>
    <div class="post-container">
      <div class="post-title">
        <h2 class="title">
          react 项目搭建
        </h2>
      </div>
      <div class="post-meta">
      </div>
      <div class="post-content">
        <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>示例项目地址：<a target="_blank" rel="noopener" href="https://github.com/zzyxka/fizzy-react">https://github.com/zzyxka/fizzy-react</a></p>
<ol>
<li>创建项目：包管理、镜像源</li>
<li><code>webpack</code> 打包配置：基础打包配置文件、使用 plugin 处理 html</li>
<li>在项目中使用 CSS：CSS Module, postCSS, 分离打包CSS</li>
<li>在项目中使用 React 和 TS - Babel</li>
<li>规范编码 Lint - ESLint, StyleLint</li>
<li>使用 Prettier 格式化项目</li>
<li>客户端路由 ReactRouter（Lazy Loading 方案）</li>
<li>开发生产分离：devServer、HMR；treeShaking、css 压缩；多线程打包、外部 CDN 等等</li>
<li>扩展<ol>
<li>UI 库：ant-design</li>
<li>状态管理 redux</li>
<li>其他流行方案：CSS IN JS 的 styled-component、Tailwind CSS 等不赘述</li>
</ol>
</li>
</ol>
<span id="more"></span>

<h1 id="1-创建项目"><a href="#1-创建项目" class="headerlink" title="1. 创建项目"></a>1. 创建项目</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> fizzy-react</span><br><span class="line"><span class="built_in">cd</span> fizzy-react</span><br><span class="line">npm init -y</span><br></pre></td></tr></table></figure>

<h2 id="1-1-包管理-pnpm"><a href="#1-1-包管理-pnpm" class="headerlink" title="1.1 包管理 pnpm"></a>1.1 包管理 <code>pnpm</code></h2><p>package.json 限定只允许使用 <code>pnpm</code> 安装项目依赖：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fizzy-react&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;main&quot;</span><span class="punctuation">:</span> <span class="string">&quot;index.js&quot;</span><span class="punctuation">,</span> <span class="comment">// 移除</span></span><br><span class="line">  <span class="attr">&quot;private&quot;</span><span class="punctuation">:</span> <span class="string">&quot;true&quot;</span><span class="punctuation">,</span> <span class="comment">// 增加</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"> 		<span class="attr">&quot;preinstall&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx only-allow pnpm&quot;</span> <span class="comment">// 增加</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;keywords&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;license&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ISC&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>注意：</p>
<ol>
<li>当前还无法限制单个包安装，比如 <code>npm i antd</code> 将不会被拦截，而 <code>npm i/install</code> 会被拦截。参见：<a target="_blank" rel="noopener" href="https://github.com/pnpm/only-allow/issues/1">https://github.com/pnpm/only-allow/issues/1</a></li>
<li>至于拦截的原理，参考官方说明的内容，即执行 <code>npm install</code> 会执行的 life cycle script，参见：<a target="_blank" rel="noopener" href="https://docs.npmjs.com/cli/v9/using-npm/scripts#npm-install">https://docs.npmjs.com/cli/v9/using-npm/scripts#npm-install</a></li>
<li>为什么要用 pnpm 而不是 npm ？- 待补充</li>
<li>设置 private 和移除 main 的原因？可参考：<a target="_blank" rel="noopener" href="https://docs.npmjs.com/cli/v9/configuring-npm/package-json">https://docs.npmjs.com/cli/v9/configuring-npm/package-json</a></li>
</ol>
<h2 id="1-2-国内镜像"><a href="#1-2-国内镜像" class="headerlink" title="1.2 国内镜像"></a>1.2 国内镜像</h2><p>创建 .npmrc 便于从国内镜像站安装依赖：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">registry=<span class="attr">https</span>:<span class="comment">//registry.npmmirror.com</span></span><br></pre></td></tr></table></figure>

<h1 id="2-webpack-打包配置"><a href="#2-webpack-打包配置" class="headerlink" title="2. webpack 打包配置"></a>2. <code>webpack</code> 打包配置</h1><ol>
<li>创建 <code>index.ejs(html)</code>, <code>src/entry.js</code> 开始准备基础打包配置</li>
<li>安装 <code>webpack</code>，创建 <code>webpack.config.js</code>，配置打包入口、出口</li>
<li>配置 clean 属性，打包时清除历史产物</li>
<li>安装并配置 HtmlWebpackPlugin 插件，使 html 模板自动引入产物（及其他操作 html 模板的动作）</li>
<li>package.json 增加打包 scripts <code>&quot;build&quot;: &quot;webpack --mode production&quot;</code></li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/entry.js</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">innerHTML</span> = <span class="string">&#x27;&lt;h1&gt;Hello Fizzy React !&lt;/h1&gt;&#x27;</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2. pnpm install webpack webpack-cli --save-dev</span></span><br><span class="line"><span class="comment">// 4. pnpm install --save-dev html-webpack-plugin</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">HtmlWebpackPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;html-webpack-plugin&#x27;</span>); <span class="comment">// 4</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">entry</span>: <span class="string">&#x27;./src/entry.js&#x27;</span>,</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HtmlWebpackPlugin</span>(&#123; <span class="comment">// 4</span></span><br><span class="line">      <span class="attr">template</span>: <span class="string">&#x27;index.ejs&#x27;</span></span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&#x27;[name].bundle.js&#x27;</span>,</span><br><span class="line">    <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;dist&#x27;</span>),</span><br><span class="line">    <span class="attr">clean</span>: <span class="literal">true</span>, <span class="comment">// 2</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<ol>
<li><code>pnpm install</code> 安装时，–save-dev 的作用是什么？待补充</li>
<li>entry 入口配置，可以配置为多入口 { a: ‘.&#x2F;a’, b: ‘.&#x2F;b’ }</li>
<li>output 输出配置，output.filename 中的 [name] 占位符，实际上是 entry 配置为多入口(对象)打包时，对象的 key 值，对应打包产物 &#x2F;dist 下的文件名plugins 配置，各种插件可以在打包过程中完成各种文件操作以实现某些所需功能。</li>
<li>关于 HtmlWebpackPlugin 还能做哪些事，详见 <a target="_blank" rel="noopener" href="https://github.com/jantimon/html-webpack-plugin">https://github.com/jantimon/html-webpack-plugin</a></li>
<li><code>webpack --mode production</code> 参数放在配置文件中亦可，下文分离打包环境，使用 mode: “development” 作为开发环境的 mode 参数。不同的 mode 设置会根据当前打包场景不同(生产&#x2F;本地开发)来设置相关的“功能”(参数或插件等)，比如生产打包代码压缩等。详见 <a target="_blank" rel="noopener" href="https://webpack.js.org/configuration/mode/#mode-development">https://webpack.js.org/configuration/mode/#mode-development</a></li>
</ol>
<h1 id="3-使用-CSS"><a href="#3-使用-CSS" class="headerlink" title="3. 使用 CSS"></a>3. 使用 CSS</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm install --save-dev style-loader css-loader</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">HtmlWebpackPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;html-webpack-plugin&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">entry</span>: <span class="string">&#x27;./src/entry.js&#x27;</span>,</span><br><span class="line">  <span class="comment">// 配置 loader</span></span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\\.css$/i</span>,</span><br><span class="line">        <span class="attr">use</span>: [<span class="string">&#x27;style-loader&#x27;</span>, <span class="string">&#x27;css-loader&#x27;</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HtmlWebpackPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">template</span>: <span class="string">&#x27;index.ejs&#x27;</span></span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&#x27;[name].bundle.js&#x27;</span>,</span><br><span class="line">    <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;dist&#x27;</span>),</span><br><span class="line">    <span class="attr">clean</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>如上述步骤，安装相关 loader 并配置 <code>webpack</code>，使项目支持在 <code>js</code> 文件里通过 <code>import &#39;./style.css&#39;;</code> 引入 CSS 样式文件。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* style.css */</span></span><br><span class="line"><span class="selector-tag">h1</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// entry.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./style.css&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">innerHTML</span> = <span class="string">&#x27;&lt;h1&gt;Hello Fizzy React !&lt;/h1&gt;&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<ol>
<li>loader 的作用：webpack 本身只能识别 js 文件，如果需要打包&#x2F;解析其他文件(如 .css .png 等)，就需要相关的 loader 将其转换为 webpack 能够识别的文件。上述代码编写后，运行 npm run build 观察打包结果，可以发现 index.html 中 head 标签内，被插入了 style 标签，其内容就是 style.css 内容，这就是 css-loader 和 style-loader 共同作用的结果，一个用于解析 CSS ，另一个用于插入 style 标签。</li>
<li>Module loaders can be chained. Each loader in the chain applies transformations to the processed resource. A chain is executed in reverse order. The first loader passes its result (resource with applied transformations) to the next one, and so forth. Finally, <code>webpack</code> expects JavaScript to be returned by the last loader in the chain.loader 链式加载，以相反(从右至左)的顺序分别使用对应的 loader 处理文件，并传递给下一个 loader，最终转换文件为能被 <code>webpack</code> 识别的 <code>js</code>。</li>
<li>The above order of loaders should be maintained: ‘style-loader’ comes first and followed by ‘css-loader’. If this convention is not followed, <code>webpack</code> is likely to throw errors.注意处理 css 文件时，两个 loader 的顺序问题。详见：<a target="_blank" rel="noopener" href="https://webpack.js.org/guides/asset-management/#loading-css">https://webpack.js.org/guides/asset-management/#loading-css</a></li>
</ol>
<h2 id="3-1-CSS-Module"><a href="#3-1-CSS-Module" class="headerlink" title="3.1 CSS Module"></a>3.1 CSS Module</h2><p>通过上述步骤，可以发现 CSS 中的文件，最终会放到一起，那就产生了“命名冲突导致样式覆盖”的问题，为了避免这一问题，可以配置 css-loader 的 modules 属性，使其支持 css module ，在不同的模块，增加不同的 hash 后缀。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">entry</span>: <span class="string">&#x27;./src/entry.js&#x27;</span>,</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\\.css$/i</span>,</span><br><span class="line">        <span class="attr">use</span>: [</span><br><span class="line">          <span class="string">&#x27;style-loader&#x27;</span>,</span><br><span class="line">          <span class="comment">// 配置 css-loader</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">loader</span>: <span class="string">&quot;css-loader&quot;</span>,</span><br><span class="line">            <span class="attr">options</span>: &#123;</span><br><span class="line">              <span class="attr">modules</span>: &#123;</span><br><span class="line">                <span class="attr">localIdentName</span>: <span class="string">&quot;[path][name]__[local]--[hash:base64:5]&quot;</span>,</span><br><span class="line">                <span class="attr">localIdentContext</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;src&quot;</span>),</span><br><span class="line">                <span class="attr">localIdentHashSalt</span>: <span class="string">&quot;react-fizzy&quot;</span>,</span><br><span class="line">              &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>注：css-loader modules 配置详见：<a target="_blank" rel="noopener" href="https://webpack.js.org/loaders/css-loader/#modules">https://webpack.js.org/loaders/css-loader/#modules</a></p>
<h2 id="3-2-PostCSS"><a href="#3-2-PostCSS" class="headerlink" title="3.2 PostCSS"></a>3.2 PostCSS</h2><p>CSS 也有很多预处理的解决方案，比如：less, sass, postCSS。less&#x2F;sass 之类，需要创建相应的 .less .scss 文件，开发中也并不会用到该语言的全部特性，所以，这里选择用 postCSS 增加一些原生 CSS 扩展(草案)功能(语法)，如：自动增加浏览器前缀(-webkit- 等)、支持嵌套语法。</p>
<p>关于 PostCSS 介绍参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://postcss.org/">https://postcss.org/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/postcss/postcss#usage">https://github.com/postcss/postcss#usage</a></li>
<li>PostCSS: A tool for transforming CSS with JavaScript<ul>
<li>Increase code readability 提高代码可读性，自动浏览器前缀 <code>Autoprefixer</code></li>
<li>Use tomorrow’s CSS today 现在就使用未来的 CSS 特性</li>
<li>The end of global CSS 前文已讲述 css-modules</li>
<li>Avoid errors in your CSS 后续讲述，使用 <code>stylelint</code> 在开发阶段避免 CSS 语法错误等</li>
<li>… …</li>
</ul>
</li>
<li>PostCSS 的理念：<a target="_blank" rel="noopener" href="https://postcss.org/docs/postcss-architecture">https://postcss.org/docs/postcss-architecture</a></li>
<li>You can start using PostCSS in just two steps:<ol>
<li>Find and add PostCSS extensions for your build tool.</li>
<li><a target="_blank" rel="noopener" href="https://www.postcss.parts/">Select plugins</a> and add them to your PostCSS process.</li>
</ol>
</li>
</ul>
<p>按照上述指示，安装 <code>postcss-loader</code> 、配置 <code>webpack</code> 并创建 <code>postcss.config.js</code> 文件来使用相关的 postCSS 插件功能，如：增加浏览器兼容前缀 <code>autoprefixer</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pnpm add -D postcss-loader postcss</span><br><span class="line">pnpm add -D autoprefixer</span><br></pre></td></tr></table></figure>

<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">entry</span>: <span class="string">&#x27;./src/entry.js&#x27;</span>,</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\\.css$/i</span>,</span><br><span class="line">        <span class="attr">use</span>: [</span><br><span class="line">          <span class="comment">// ...</span></span><br><span class="line">          <span class="string">&#x27;postcss-loader&#x27;</span> <span class="comment">// 在原有基础上，增加 postcss 处理 css 文件</span></span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// postcss.config.js</span></span><br><span class="line"><span class="comment">// 单独创建文件便于维护，也可以配置在 webpack.config.js 中对应位置</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="string">&#x27;autoprefixer&#x27;</span>,</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在 style.css 中，增加 <code>user-select: none;</code> 并执行打包，打开浏览器调试可以发现属性内核前缀。</p>
<p>正如官方描述所说，当前很多 CSS3 属性已经标准化，很大一部分已经不用声明浏览器内核前缀了，当前还会生成前缀的属性，详见：<a target="_blank" rel="noopener" href="https://github.com/postcss/autoprefixer#debug">https://github.com/postcss/autoprefixer#debug</a></p>
<p>同样的方式，安装并配置 <a target="_blank" rel="noopener" href="https://github.com/csstools/postcss-plugins/tree/main/plugin-packs/postcss-preset-env">postcss-preset-env</a>，使 css 支持草案语法。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* style.css */</span></span><br><span class="line"></span><br><span class="line"><span class="selector-class">.h1</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: red;</span><br><span class="line">  user-select: none;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 使用嵌套语法 */</span></span><br><span class="line">  <span class="selector-tag">span</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: blue;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 <code>vscode</code> 注意：安装 PostCSS Intellisense and Highlighting 插件，防止 <code>stylelint</code> 误报，如嵌套等草案语法错误。（注意：如果选择安装 PostCSS Language Support 这个插件会导致 vscode CSS 属性&#x2F;值补全失效）</p>
<h2 id="3-3-分离打包CSS"><a href="#3-3-分离打包CSS" class="headerlink" title="3.3 分离打包CSS"></a>3.3 分离打包CSS</h2><p>到现在为止，CSS 内容都是被打包到 js 中，然后插入到页面的 head 标签中，并没有分离出独立的 css 文件，接下来，使用 MiniCssExtractPlugin 来分离 CSS 文件以及做进一步优化。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://webpack.js.org/plugins/mini-css-extract-plugin/#minimizing-for-production">https://webpack.js.org/plugins/mini-css-extract-plugin/#minimizing-for-production</a></p>
<p>This plugin extracts CSS into separate files. It creates a CSS file per JS file which contains CSS. It supports On-Demand-Loading of CSS and SourceMaps.</p>
<p>此插件可将 CSS 提取到单独的文件中。它会为每个包含 CSS 的 JS 文件创建一个 CSS 文件。它支持 CSS 和源码图的 “按需加载”。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm add -D mini-css-extract-plugin</span><br></pre></td></tr></table></figure>

<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MiniCssExtractPlugin</span> = <span class="built_in">require</span>(<span class="string">&quot;mini-css-extract-plugin&quot;</span>); <span class="comment">// 引入插件</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">HtmlWebpackPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;html-webpack-plugin&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">entry</span>: <span class="string">&#x27;./src/entry.js&#x27;</span>,</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\\.css$/i</span>,</span><br><span class="line">        <span class="attr">use</span>: [</span><br><span class="line">          <span class="comment">// 不再需要 style-loader</span></span><br><span class="line">          <span class="title class_">MiniCssExtractPlugin</span>.<span class="property">loader</span>, <span class="comment">// 添加插件提供的 loader</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">loader</span>: <span class="string">&quot;css-loader&quot;</span>,</span><br><span class="line">            <span class="attr">options</span>: &#123;</span><br><span class="line">              <span class="attr">modules</span>: &#123;</span><br><span class="line">                <span class="attr">localIdentName</span>: <span class="string">&quot;[path][name]__[local]--[hash:base64:5]&quot;</span>,</span><br><span class="line">                <span class="attr">localIdentContext</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;src&quot;</span>),</span><br><span class="line">                <span class="attr">localIdentHashSalt</span>: <span class="string">&quot;react-fizzy&quot;</span>,</span><br><span class="line">              &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&#x27;postcss-loader&#x27;</span></span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">MiniCssExtractPlugin</span>(), <span class="comment">// 使用插件</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HtmlWebpackPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">template</span>: <span class="string">&#x27;index.ejs&#x27;</span></span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&#x27;[name].bundle.js&#x27;</span>,</span><br><span class="line">    <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;dist&#x27;</span>),</span><br><span class="line">    <span class="attr">clean</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>执行 <code>npm run build</code> 观察产物，可以发现已经独立引入 css 文件 <code>&lt;link href=&quot;main.css&quot; rel=&quot;stylesheet&quot;&gt;</code>。</p>
<h1 id="4-使用-React-和-TS"><a href="#4-使用-React-和-TS" class="headerlink" title="4. 使用 React 和 TS"></a>4. 使用 React 和 TS</h1><p>像是 PostCSS 生态一样，Babel 也有生态，处理各种各样的 js 扩展语法。</p>
<p>关于 babel 的介绍：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://babeljs.io/">https://babeljs.io/</a></li>
<li>Babel is a JavaScript compiler. Use next generation JavaScript, today.</li>
<li>Babel is a toolchain that is mainly used to convert ECMAScript 2015+ code into a backwards compatible version of JavaScript in current and older browsers or environments. Here are the main things Babel can do for you:<ul>
<li>Transform syntax</li>
<li><code>Polyfill</code> features that are missing in your target environment (through a third-party <code>polyfill</code> such as <a target="_blank" rel="noopener" href="https://github.com/zloirock/core-js">core-js</a>)</li>
<li>Source code transformations (<code>codemods</code>)</li>
<li>And more! (check out these <a target="_blank" rel="noopener" href="https://babeljs.io/videos">videos</a> for inspiration)</li>
</ul>
</li>
</ul>
<p>Babel 有自己的命令行，安装 Babel 相关依赖，并配置 babel.config.json 相关内容，在命令行运行即可将项目中的高级语法转换为兼容浏览器运行的 js 文件。但我们不会每次运行项目，先运行 babel-cli 再运行 webpack-cli，所以需要借助 babel-loader 来将其配置再 webpack 中。</p>
<p>就如 <code>webpack</code> 的 entry&#x2F;output&#x2F;loader&#x2F;plugin 一样，Babel 也有几个 核心概念：Plugins &amp; Presets、 <code>Polyfill</code>。</p>
<p><strong>Plugins &amp; Presets</strong></p>
<p>使用 Plugins(插件) 来做转换，而 Presets(预设) 像是一组 Plugins 的合集。比如：可以组合使用 箭头函数 等插件完成 ES6+ 的语法转换，也可以直接使用 @babel&#x2F;preset-env 来转换所有 ES6+ 语法。同理，使用 @babel&#x2F;preset-react 转换所有 <code>react/jsx</code> 语法。同理还有 @babel&#x2F;preset-typescript。</p>
<p><strong>Polyfill</strong></p>
<p>使用 Plugins &amp; Presets 只是转换了语法，而一些 ES6+ 出现的新对象，就需要 Polyfill 出马，来在旧版本中”模拟“创建这个对象。</p>
<p>需要酌情考虑，毕竟引入一个完整的 polyfill js 文件会占一定体积，影响首屏加载速度。如果必须要，考虑用 CDN 加载或者只导入部分需要用的内容。</p>
<blockquote>
<p>As of Babel 7.4.0, this package has been deprecated in favor of directly including core-js&#x2F;stable (to polyfill ECMAScript features)</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;core-js/stable&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>The <a target="_blank" rel="noopener" href="https://babeljs.io/docs/babel-polyfill">@babel&#x2F;polyfill</a> module includes <a target="_blank" rel="noopener" href="https://github.com/zloirock/core-js">core-js</a> and a custom <a target="_blank" rel="noopener" href="https://github.com/facebook/regenerator/blob/main/packages/runtime/runtime.js">regenerator runtime</a> to emulate a full ES2015+ environment.</p>
<p>This means you can use new built-ins like <code>Promise</code> or <code>WeakMap</code>, static methods like <code>Array.from</code> or <code>Object.assign</code>, instance methods like <code>Array.prototype.includes</code>, and generator functions (when used alongside the regenerator plugin). The polyfill adds to the global scope as well as native prototypes like <code>String</code> in order to do this.</p>
<p>Importing <code>&quot;core-js&quot;</code> loads polyfills for every possible ECMAScript feature: what if you know that you only need some of them? When using <code>core-js@3</code>, <code>@babel/preset-env</code> is able to optimize every single <code>core-js</code> entrypoint and their combinations. For example, you might want to only polyfill array methods and new <code>Math</code> proposals:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;core-js/es/array&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;core-js/proposals/math-extensions&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>You can read <a target="_blank" rel="noopener" href="https://github.com/zloirock/core-js">core-js</a>‘s documentation for more information about the different entry points.</p>
</blockquote>
<p>为项目支持 ES6+ 和 React，安装相关依赖，并完成配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pnpm install --save-dev babel-loader @babel/core</span><br><span class="line">pnpm install --save-dev @babel/preset-env @babel/preset-react</span><br><span class="line">pnpm add core-js@3 <span class="comment"># polyfill</span></span><br><span class="line">pnpm add react react-dom</span><br></pre></td></tr></table></figure>

<p><strong>babel.config.json</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;presets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;@babel/preset-env&quot;</span><span class="punctuation">,</span> <span class="string">&quot;@babel/preset-react&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js 省略其他内容</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">test</span>: <span class="regexp">/\\.js|jsx$/i</span>,</span><br><span class="line">  <span class="attr">use</span>: <span class="string">&#x27;babel-loader&#x27;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// entry.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;core-js&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createRoot &#125; <span class="keyword">from</span> <span class="string">&#x27;react-dom/client&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> style <span class="keyword">from</span> <span class="string">&#x27;./style.css&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">innerHTML</span> = <span class="string">&#x27;&lt;div id=&quot;app&quot;&gt;&lt;/div&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> root = <span class="title function_">createRoot</span>(<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;app&#x27;</span>));</span><br><span class="line">root.<span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">className</span>=<span class="string">&#123;style.h1&#125;</span>&gt;</span>Hello <span class="tag">&lt;<span class="name">span</span>&gt;</span>Fizzy<span class="tag">&lt;/<span class="name">span</span>&gt;</span> React !<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>);</span><br></pre></td></tr></table></figure>

<h2 id="增加-TS-支持"><a href="#增加-TS-支持" class="headerlink" title="增加 TS 支持"></a>增加 TS 支持</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pnpm add typescript -D</span><br><span class="line">pnpm add --save-dev @babel/preset-typescript</span><br><span class="line">pnpm install --save-dev @types/react @types/react-dom</span><br></pre></td></tr></table></figure>

<p><strong>babel.config.js</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;presets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;@babel/preset-env&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;@babel/preset-react&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;@babel/preset-typescript&quot;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// entry.tsx</span></span><br><span class="line"><span class="comment">// import &quot;core-js&quot;;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createRoot &#125; <span class="keyword">from</span> <span class="string">&#x27;react-dom/client&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">innerHTML</span> = <span class="string">&#x27;&lt;div id=&quot;app&quot;&gt;&lt;/div&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> rootElement = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;app&#x27;</span>) ?? <span class="variable language_">document</span>.<span class="property">body</span>;</span><br><span class="line"><span class="keyword">const</span> root = <span class="title function_">createRoot</span>(rootElement);</span><br><span class="line">root.<span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span></span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// App.tsx</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> style <span class="keyword">from</span> <span class="string">&#x27;./style.css&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">App</span> (): <span class="title class_">React</span>.<span class="property">ReactElement</span>&lt;any, any&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">h1</span> <span class="attr">className</span>=<span class="string">&#123;style.h1&#125;</span>&gt;</span>Hello <span class="tag">&lt;<span class="name">span</span>&gt;</span>Fizzy<span class="tag">&lt;/<span class="name">span</span>&gt;</span> React !<span class="tag">&lt;/<span class="name">h1</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 webpack 中配置引入文件忽略 .ts .tsx 后缀</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">resolve</span>: &#123;</span><br><span class="line">  <span class="attr">extensions</span>: [<span class="string">&#x27;.ts&#x27;</span>, <span class="string">&#x27;.tsx&#x27;</span>],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>关于 <code>tsx</code> 中引入 style.css 在 <code>vscode</code> 内报错：找不到模块“.&#x2F;style.css”或其相应的类型声明。ts(2307)</p>
<p>参考：<a target="_blank" rel="noopener" href="https://github.com/Microsoft/TypeScript/issues/30055">https://github.com/Microsoft/TypeScript/issues/30055</a></p>
<p>解决方案：</p>
<ol>
<li>在项目下创建 &#x2F;src&#x2F;typings&#x2F;global.d.ts 内容为</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> <span class="variable language_">module</span> <span class="string">&#x27;*.css&#x27;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">classes</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;;</span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">default</span> classes;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">declare</span> <span class="variable language_">module</span> <span class="string">&#x27;*.less&#x27;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">classes</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;;</span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">default</span> classes;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">declare</span> <span class="variable language_">module</span> <span class="string">&#x27;process&#x27;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">classes</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;;</span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">default</span> classes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="variable language_">module</span> <span class="string">&#x27;*.svg&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">interface</span> <span class="title class_">Window</span> &#123;</span><br><span class="line">  selfIncrementingReactListKey?: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在项目根目录创建 <code>tsconfig.json</code> 来 include src 下的 ts 模块</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;compilerOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;outDir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;build&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;baseUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;.&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;allowJs&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;strict&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;module&quot;</span><span class="punctuation">:</span> <span class="string">&quot;esnext&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;target&quot;</span><span class="punctuation">:</span> <span class="string">&quot;esnext&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sourceMap&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;jsx&quot;</span><span class="punctuation">:</span> <span class="string">&quot;react&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipLibCheck&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;noUnusedLocals&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;esModuleInterop&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;noImplicitReturns&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;resolveJsonModule&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;moduleResolution&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;experimentalDecorators&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;lib&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;esnext&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;dom&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;WebWorker&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;forceConsistentCasingInFileNames&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;paths&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;include&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;src/**/*.ts&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;src/**/*.tsx&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;src/**/*.d.ts&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;exclude&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;node_modules&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;build&quot;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h1 id="5-规范编码-Lint"><a href="#5-规范编码-Lint" class="headerlink" title="5. 规范编码 Lint"></a>5. 规范编码 Lint</h1><h2 id="5-1-ESLint"><a href="#5-1-ESLint" class="headerlink" title="5.1 ESLint"></a>5.1 ESLint</h2><p>参考：<a target="_blank" rel="noopener" href="https://eslint.org/docs/latest/use/getting-started">https://eslint.org/docs/latest/use/getting-started</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm init @eslint/config</span><br></pre></td></tr></table></figure>

<p>执行上述命令，按步骤选择即可，注意最后选择 pnpm 安装方式。</p>
<p>安装后，<code>.eslintrc.js</code> 需要增加 <code>parserOptions.project = [&quot;./tsconfig.json&quot;]</code>，否则 ESlint 报错无法运行。报错如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error: Error <span class="keyword">while</span> loading rule <span class="string">&#x27;@typescript-eslint/dot-notation&#x27;</span>: You have used a rule <span class="built_in">which</span> requires parserServices to be generated. You must therefore provide a value <span class="keyword">for</span> the <span class="string">&quot;parserOptions.project&quot;</span> property <span class="keyword">for</span> @typescript-eslint/parser.</span><br></pre></td></tr></table></figure>

<p>关于 .tsx 文件顶部注释下述报错，可通过 <code>Add &quot;strictNullChecks&quot;: true to the &quot;compilerOptions&quot; object in tsconfig.json did the trick</code> 解决，可能需要重启 vscode。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://github.com/standard/eslint-config-standard-with-typescript/issues/481">https://github.com/standard/eslint-config-standard-with-typescript/issues/481</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error: <span class="string">&quot;This rule requires the strictNullChecks compiler option to be turned on to function correctly @typescript-eslint/strict-boolean-expressions&quot;</span> <span class="comment">#481</span></span><br></pre></td></tr></table></figure>

<p>最后，可以在 ESlint 规则文件中，自定义相关规则，满足团队编码习惯。</p>
<h2 id="5-2-StyleLint"><a href="#5-2-StyleLint" class="headerlink" title="5.2 StyleLint"></a>5.2 StyleLint</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm install --save-dev stylelint stylelint-config-standard</span><br></pre></td></tr></table></figure>

<p>创建 <code>.stylelintrc.json</code> 配置文件，可以在 rules 中增加一些规则，如 max-nesting-depth 设置嵌套层级不超过2层：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;extends&quot;</span><span class="punctuation">:</span> <span class="string">&quot;stylelint-config-standard&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;max-nesting-depth&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>更多规则详见：<a target="_blank" rel="noopener" href="https://stylelint.io/user-guide/rules">https://stylelint.io/user-guide/rules</a></p>
<p>StyleLint 也支持安装一些 plugins 来满足 CSS lint &#x2F;格式化的一些需求，如使用 <code>stylelint-order</code> 规范 CSS 的属性排序。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm install stylelint-order --save-dev</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;extends&quot;</span><span class="punctuation">:</span> <span class="string">&quot;stylelint-config-standard&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;stylelint-order&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;max-nesting-depth&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;order/properties-order&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;position&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;top&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;right&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;bottom&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;left&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;display&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;margin&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;padding&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;width&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;height&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;border&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;background&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;font-size&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;font-weight&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;color&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>stylelint-order</code> 的其他功能详见：<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/stylelint-order">https://www.npmjs.com/package/stylelint-order</a></p>
<p><code>vscode/settings.json</code> 设置保存时，自动使用 <code>stylelint</code> 格式化，css 属性顺序就会按照配置文件纠正。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;editor.codeActionsOnSave&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;source.fixAll.stylelint&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<h1 id="6-使用-Prettier-格式化项目"><a href="#6-使用-Prettier-格式化项目" class="headerlink" title="6. 使用 Prettier 格式化项目"></a>6. 使用 Prettier 格式化项目</h1><p><a target="_blank" rel="noopener" href="https://prettier.io/docs/en/">https://prettier.io/docs/en/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pnpm add --save-dev --save-exact prettier</span><br><span class="line"><span class="built_in">echo</span> &#123;&#125;&gt; .prettierrc.json <span class="comment"># 创建配置文件</span></span><br><span class="line"><span class="built_in">echo</span> &gt; .prettierignore <span class="comment"># 创建排除配置文件</span></span><br></pre></td></tr></table></figure>

<p>If you use ESLint, install <a target="_blank" rel="noopener" href="https://github.com/prettier/eslint-config-prettier#installation">eslint-config-prettier</a> to make ESLint and Prettier play nice with each other. It turns off all ESLint rules that are unnecessary or might conflict with Prettier. There’s a similar config for Stylelint: <a target="_blank" rel="noopener" href="https://github.com/prettier/stylelint-config-prettier">stylelint-config-prettier</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pnpm install --save-dev eslint-config-prettier</span><br><span class="line">pnpm install --save-dev stylelint-config-prettier</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .eslintrc.js</span></span><br><span class="line"><span class="string">&quot;extends&quot;</span>: [</span><br><span class="line">  <span class="string">&quot;standard-with-typescript&quot;</span>,</span><br><span class="line">  <span class="string">&quot;plugin:react/recommended&quot;</span>,</span><br><span class="line">  <span class="string">&quot;prettier&quot;</span></span><br><span class="line">],</span><br><span class="line"></span><br><span class="line"><span class="comment">// .stylelintrc.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;extends&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;stylelint-config-standard&quot;</span>,</span><br><span class="line">    <span class="string">&quot;stylelint-config-prettier&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>vscode 安装 Prettier - Code formatter 插件，大功告成，几乎所有类型文件，都可以用它来格式化了。</p>
<h1 id="7-客户端路由"><a href="#7-客户端路由" class="headerlink" title="7. 客户端路由"></a>7. 客户端路由</h1><p>单页应用的客户端路由方案：ReactRouter，这里基于 v6.15.0 版本。</p>
<p>跟做一遍官网的<a target="_blank" rel="noopener" href="https://reactrouter.com/en/main/start/tutorial#setup">指南</a>，可以领略到 ReactRouter 的设计理念，它并非是“客户端页面地址管理器，把单页应用变多页应用”这么简单，结合各类 Hook 及开发中容易遇到的业务场景，它有一套完整的设计理念类比“传统”的表单提交和接口请求策略。</p>
<p>而大多数项目中，往往只是把它当做“客户端页面地址管理器”来使用了。先不探讨其各类强大的功能，这里我们先利用它的“基础功能”，将当前项目变成能够切换路由的“多页面项目”。</p>
<ol>
<li>安装 react-router-dom 依赖 <code>pnpm add react-router-dom</code></li>
<li>创建 src&#x2F;pages 目录，用于存放独立的页面。对于绝大部分系统，个人感觉没必要多层级创建页面目录，避免嵌套关系引发的各类问题，对于有关联的页面，可以从命名上整合，故此处约定 pages 目录下，第一层级的目录视为页面。创建 &#x2F;src&#x2F;pages&#x2F;home 作为首页，创建 &#x2F;src&#x2F;pages&#x2F;demo-list 作为示例列表页，创建 &#x2F;src&#x2F;pages&#x2F;demo-detail 作为示例详情页</li>
<li>创建 src&#x2F;layout 目录，用于存放系统基础框架。在 layout&#x2F;Index.tsx 下，展示菜单 demo </li>
<li>创建 src&#x2F;router.tsx ，改造 src&#x2F;App.tsx ，渲染 router 配置</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// App.tsx</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">RouterProvider</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">App</span> (): <span class="title class_">React</span>.<span class="property">ReactElement</span>&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">RouterProvider</span> <span class="attr">router</span>=<span class="string">&#123;router&#125;</span> /&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// router.tsx</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createHashRouter &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Layout</span> <span class="keyword">from</span> <span class="string">&#x27;./layout/Index&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Home</span> <span class="keyword">from</span> <span class="string">&#x27;./pages/home/Index&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">List</span> <span class="keyword">from</span> <span class="string">&#x27;./pages/demo-list/Index&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Detail</span> <span class="keyword">from</span> <span class="string">&#x27;./pages/demo-detail/Index&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> routeConfig = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;demo-list&#x27;</span>, <span class="attr">element</span>: <span class="language-xml"><span class="tag">&lt;<span class="name">List</span> /&gt;</span></span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;demo-detail&#x27;</span>, <span class="attr">element</span>: <span class="language-xml"><span class="tag">&lt;<span class="name">Detail</span> /&gt;</span></span> &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">createHashRouter</span>([</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">    <span class="attr">element</span>: <span class="language-xml"><span class="tag">&lt;<span class="name">Layout</span> /&gt;</span></span>,</span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">      &#123; <span class="attr">index</span>: <span class="literal">true</span>, <span class="attr">element</span>: <span class="language-xml"><span class="tag">&lt;<span class="name">Home</span> /&gt;</span></span> &#125;,</span><br><span class="line">      ...routeConfig</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// src/layout/Index.tsx</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Outlet</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Nav</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Nav<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/&quot;</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#/demo-list&quot;</span>&gt;</span>List<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#/demo-detail&quot;</span>&gt;</span>Detail<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Nav</span> /&gt;</span> &#123;/* 框架：当前是菜单/导航，也可以是其他任何内容渲染 */&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Outlet</span> /&gt;</span> &#123;/* 渲染路由匹配的实际页面内容 */&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// src/pages/home/Index.tsx</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Home</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>思考：BrowserRouter 和 HashRouter 区别是什么？如何选择？</p>
<p>做完上述4步，已经能够实现基础的导航-页面切换功能，接下来做一些项目中常见&#x2F;必备的能力：</p>
<ol>
<li><p>实现匹配菜单项高亮功能（使用 <code>NavLink</code>）</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/layout/Index.tsx</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Outlet</span>, <span class="title class_">NavLink</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> style <span class="keyword">from</span> <span class="string">&#x27;./layout.css&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Nav</span> () &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">isActiveClassName</span> = (<span class="params">&#123; isActive &#125;</span>) =&gt; isActive ? <span class="string">`<span class="subst">$&#123;style[<span class="string">&#x27;nav-item&#x27;</span>]&#125;</span> <span class="subst">$&#123;style.active&#125;</span>`</span> : style[<span class="string">&#x27;nav-item&#x27;</span>];</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;style[</span>&#x27;<span class="attr">layout-nav</span>&#x27;]&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Nav<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">NavLink</span> <span class="attr">to</span>=<span class="string">&quot;/&quot;</span> <span class="attr">className</span>=<span class="string">&#123;isActiveClassName&#125;</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">NavLink</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">NavLink</span> <span class="attr">to</span>=<span class="string">&quot;demo-list&quot;</span> <span class="attr">className</span>=<span class="string">&#123;isActiveClassName&#125;</span>&gt;</span>List<span class="tag">&lt;/<span class="name">NavLink</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">NavLink</span> <span class="attr">to</span>=<span class="string">&quot;demo-detail&quot;</span> <span class="attr">className</span>=<span class="string">&#123;isActiveClassName&#125;</span>&gt;</span>Detail<span class="tag">&lt;/<span class="name">NavLink</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 src&#x2F;components 目录，用于存放公共组件，创建 src&#x2F;components&#x2F;PageLoading.tsx，实现页面切换 loading 功能（这里的 loading 是整个项目级别的，需要考虑实际情况是否使用，切换页面时，若目标页面进入时 router.loader 阻塞过久，对应匹配的 NavLink 也是等待匹配状态，会有交互歧义）</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useNavigation &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span>;</span><br><span class="line"><span class="comment">// 这里用到了别名，需要在 webpack.config.js 和 tsconfig.json 中设置</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">PageLoading</span> <span class="keyword">from</span> <span class="string">&#x27;@/components/PageLoading&#x27;</span>; </span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span> () &#123;</span><br><span class="line">  <span class="keyword">const</span> navigation = <span class="title function_">useNavigation</span>();</span><br><span class="line">  <span class="keyword">const</span> isLoading = navigation.<span class="property">state</span> === <span class="string">&#x27;loading&#x27;</span>;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Nav</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;isLoading &amp;&amp; <span class="tag">&lt;<span class="name">PageLoading</span> /&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Outlet</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="attr">resolve</span>: &#123;</span><br><span class="line">  <span class="attr">extensions</span>: [<span class="string">&#x27;.ts&#x27;</span>, <span class="string">&#x27;.tsx&#x27;</span>],</span><br><span class="line">  <span class="attr">alias</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;@&#x27;</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;src&#x27;</span>) <span class="comment">// 别名设置</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;,</span><br><span class="line">  </span><br><span class="line"><span class="comment">// tsconfig.json</span></span><br><span class="line"><span class="string">&quot;paths&quot;</span>: &#123;</span><br><span class="line">  <span class="string">&quot;@/*&quot;</span>: [<span class="string">&quot;./src/*&quot;</span>],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>按需加载页面资源(访问对应页面时再加载组件 js&#x2F;css)，此处的 Suspense.fallback 中渲染 loading 会更实用。</p>
<ul>
<li><p>选用方案：<a target="_blank" rel="noopener" href="https://react.dev/reference/react/lazy#lazy">https://react.dev/reference/react/lazy#lazy</a></p>
</li>
<li><p>可选方案：<a target="_blank" rel="noopener" href="https://reactrouter.com/en/main/route/lazy">https://reactrouter.com/en/main/route/lazy</a></p>
</li>
</ul>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router.tsx</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; lazy, <span class="title class_">Suspense</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createHashRouter &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Layout</span> <span class="keyword">from</span> <span class="string">&#x27;./layout/Index&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Home</span> <span class="keyword">from</span> <span class="string">&#x27;./pages/home/Index&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">List</span> = <span class="title function_">lazy</span>(<span class="keyword">async</span> () =&gt; <span class="keyword">await</span> <span class="keyword">import</span>(<span class="string">&#x27;./pages/demo-list/Index&#x27;</span>));</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Detail</span> = <span class="title function_">lazy</span>(<span class="keyword">async</span> () =&gt; <span class="keyword">await</span> <span class="keyword">import</span>(<span class="string">&#x27;./pages/demo-detail/Index&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> routeConfig = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;demo-list&#x27;</span>, <span class="attr">element</span>: <span class="language-xml"><span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&#x27;<span class="attr">loading</span>&#x27;&#125;&gt;</span><span class="tag">&lt;<span class="name">List</span> /&gt;</span><span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;demo-detail&#x27;</span>, <span class="attr">element</span>: <span class="language-xml"><span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&#x27;<span class="attr">loading</span>&#x27;&#125;&gt;</span><span class="tag">&lt;<span class="name">Detail</span> /&gt;</span><span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span> &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">createHashRouter</span>([</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">    <span class="attr">element</span>: <span class="language-xml"><span class="tag">&lt;<span class="name">Layout</span> /&gt;</span></span>,</span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">      &#123; <span class="attr">index</span>: <span class="literal">true</span>, <span class="attr">element</span>: <span class="language-xml"><span class="tag">&lt;<span class="name">Home</span> /&gt;</span></span> &#125;,</span><br><span class="line">      ...routeConfig</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
</li>
<li><p>解耦独立页面路由配置文件，使项目具备页面自动生成路由。</p>
<p>为什么这么做？从上一步可以看出，每新增一个页面，我们就要维护 router.jsx 增加路由配置，这样 router.tsx 就会越来越大，且不便于检索对应页面的路由配置，所以我们需要通过某些手段解耦，将对应页面的路由配置，放到对应页面目录下。</p>
<p>明确下我们的目标，即下述代码注释部分，需要在打包时遍历 pages&#x2F;* 自动生成页面路由配置：</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router.tsx</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="comment">/*, &#123; lazy, Suspense &#125; */</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createHashRouter &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Layout</span> <span class="keyword">from</span> <span class="string">&#x27;./layout/Index&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Home</span> <span class="keyword">from</span> <span class="string">&#x27;./pages/home/Index&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// const List = lazy(async () =&gt; await import(&#x27;./pages/demo-list/Index&#x27;));</span></span><br><span class="line"><span class="comment">// const Detail = lazy(async () =&gt; await import(&#x27;./pages/demo-detail/Index&#x27;));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// const routeConfig = [</span></span><br><span class="line"><span class="comment">//   &#123; path: &#x27;demo-list&#x27;, element: &lt;Suspense fallback=&#123;&#x27;loading&#x27;&#125;&gt;&lt;List /&gt;&lt;/Suspense&gt; &#125;,</span></span><br><span class="line"><span class="comment">//   &#123; path: &#x27;demo-detail&#x27;, element: &lt;Suspense fallback=&#123;&#x27;loading&#x27;&#125;&gt;&lt;Detail /&gt;&lt;/Suspense&gt; &#125;</span></span><br><span class="line"><span class="comment">// ];</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">createHashRouter</span>([</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">    <span class="attr">element</span>: <span class="language-xml"><span class="tag">&lt;<span class="name">Layout</span> /&gt;</span></span>,</span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">      &#123; <span class="attr">index</span>: <span class="literal">true</span>, <span class="attr">element</span>: <span class="language-xml"><span class="tag">&lt;<span class="name">Home</span> /&gt;</span></span> &#125;,</span><br><span class="line">      ...routeConfig</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]);</span><br></pre></td></tr></table></figure></li>
</ol>
<p>​		详见：实现一个 webpack plugin (TODO: router-plugin)</p>
<h1 id="8-开发生产分离"><a href="#8-开发生产分离" class="headerlink" title="8. 开发生产分离"></a>8. 开发生产分离</h1><h2 id="8-1-开发环境配置"><a href="#8-1-开发环境配置" class="headerlink" title="8.1 开发环境配置"></a>8.1 开发环境配置</h2><p>复制当前配置文件，创建 <code>webpack.dev.js</code> 用于开发环境的打包配置。</p>
<p>在 package.json 中，增加 dev scripts 用于开发环境打包。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;preinstall&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx only-allow pnpm&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;dev&quot;</span><span class="punctuation">:</span> <span class="string">&quot;webpack serve --config webpack.dev.js --progress --color&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;webpack --config webpack.config.js --progress --color&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<p>思考一下开发环境需要的一些能力：</p>
<ul>
<li>前文提到的 mode - development</li>
<li>易于调试 source-map</li>
<li>本地代理服务器 devServer（包括解决跨域，代理转发转发后端API的能力）</li>
<li>热更新 HMR</li>
</ul>
<h3 id="8-1-1-使用-source-map"><a href="#8-1-1-使用-source-map" class="headerlink" title="8.1.1 使用 source-map"></a>8.1.1 使用 source-map</h3><p><a target="_blank" rel="noopener" href="https://webpack.js.org/guides/development/#using-source-maps">https://webpack.js.org/guides/development/#using-source-maps</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">devtool</span>: <span class="string">&#x27;inline-source-map&#x27;</span>,</span><br></pre></td></tr></table></figure>

<h3 id="8-1-2-本地代理服务器"><a href="#8-1-2-本地代理服务器" class="headerlink" title="8.1.2 本地代理服务器"></a>8.1.2 本地代理服务器</h3><p><a target="_blank" rel="noopener" href="https://webpack.js.org/guides/development/#using-webpack-dev-server">https://webpack.js.org/guides/development/#using-webpack-dev-server</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm install --save-dev webpack-dev-server</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">devServer</span>: &#123;</span><br><span class="line">  <span class="attr">static</span>: &#123;</span><br><span class="line">    <span class="attr">directory</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;dist&#x27;</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">compress</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">port</span>: <span class="number">9000</span>,</span><br><span class="line">  <span class="attr">open</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>使用 <code>npm run dev</code> 启动项目，此时浏览器自动打开本地 URL，修改页面代码会触发浏览器刷新。</p>
<p>实际开发过程中，我们还需要配置 proxy 来将约定某前缀路由，转发到后端 API，解决本地访问的跨域问题。</p>
<p>举例：项目中 <code>fetch(&#39;/api/xxx&#39;)</code> 此时，以 <code>/api</code> 开头的请求，我们都通过 proxy 转发到后端实际的开发环境服务器（生产部署使用 ng 进行转发）。</p>
<p><a target="_blank" rel="noopener" href="https://webpack.js.org/configuration/dev-server/#devserverproxy">https://webpack.js.org/configuration/dev-server/#devserverproxy</a></p>
<ol>
<li><p>在 webpack 配置文件中，使用环境变量来代表 <code>/api</code> 即某一类后端请求</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> webpack.<span class="title class_">DefinePlugin</span>(&#123;</span><br><span class="line">  <span class="string">&#x27;process.env.POKE_API&#x27;</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="string">&#x27;api&#x27;</span>),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>为 devServer 添加 proxy 配置，使页面再请求 <code>origin/api/xxx</code> 时，转发请求到后端服务地址</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">devServer</span>: &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">proxy</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;/api&#x27;</span>: &#123;</span><br><span class="line">      <span class="attr">target</span>: <span class="string">&#x27;https://pokeapi.co&#x27;</span>,</span><br><span class="line">      <span class="attr">secure</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">changeOrigin</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
</li>
<li><p>在页面上使用 <code>fetch</code> 发起请求</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> (<span class="keyword">async</span> (): <span class="function"><span class="params">void</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">`<span class="subst">$&#123;process.env.POKE_API&#125;</span>/v2/pokemon`</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;res: &quot;</span>, res);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="8-1-3-“热更新”"><a href="#8-1-3-“热更新”" class="headerlink" title="8.1.3 “热更新”"></a>8.1.3 “热更新”</h3><p><a target="_blank" rel="noopener" href="https://webpack.js.org/guides/hot-module-replacement/">https://webpack.js.org/guides/hot-module-replacement/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/gaearon/react-hot-loader">https://github.com/gaearon/react-hot-loader</a></p>
<p>过去通过 HMR 热更新完成组件变化局部更新的开发体验，从上述参考内容中，可以发现该方式已经被 React Fash Refresh 方式取代。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/pmmmwh/react-refresh-webpack-plugin">https://github.com/pmmmwh/react-refresh-webpack-plugin</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm add -D @pmmmwh/react-refresh-webpack-plugin react-refresh</span><br></pre></td></tr></table></figure>

<p>有变动的相关 <code>webpack.dev.js</code> 内容如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">devServer</span>: &#123;</span><br><span class="line">    <span class="attr">static</span>: &#123;</span><br><span class="line">      <span class="attr">directory</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;dist&#x27;</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">compress</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">port</span>: <span class="number">9000</span>,</span><br><span class="line">    <span class="attr">open</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">hot</span>: <span class="literal">true</span> <span class="comment">// 开启</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.[jt]sx?$/</span>,</span><br><span class="line">        <span class="attr">exclude</span>: <span class="regexp">/node_modules/</span>,</span><br><span class="line">        <span class="attr">use</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">loader</span>: <span class="built_in">require</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;babel-loader&#x27;</span>),</span><br><span class="line">            <span class="attr">options</span>: &#123;</span><br><span class="line">              <span class="attr">plugins</span>: [<span class="built_in">require</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;react-refresh/babel&#x27;</span>)],</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="comment">// other plugin</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ReactRefreshWebpackPlugin</span>()</span><br><span class="line">  ],</span><br></pre></td></tr></table></figure>

<p>配置完成后，改变 React Component 内容，将会动态加载到页面上，而不会刷新页面。</p>
<p>为了让独立文件的 css 也能热更新，需要继续修改配置（移除 hash 新产物覆盖旧产物）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">plugins</span>: [</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">HtmlWebpackPlugin</span>(&#123;</span><br><span class="line">    <span class="attr">template</span>: <span class="string">&#x27;template/dev.ejs&#x27;</span></span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">MiniCssExtractPlugin</span>(&#123;</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&quot;[name].css&quot;</span>, <span class="comment">// 移除 hash</span></span><br><span class="line">    <span class="attr">chunkFilename</span>: <span class="string">&quot;[id].css&quot;</span>, <span class="comment">// 移除 hash</span></span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">ReactRefreshWebpackPlugin</span>(),</span><br><span class="line">],</span><br><span class="line"><span class="attr">output</span>: &#123;</span><br><span class="line">  <span class="attr">filename</span>: <span class="string">&#x27;[name].bundle.js&#x27;</span>, <span class="comment">// 移除 hash</span></span><br><span class="line">  <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;dist&#x27;</span>),</span><br><span class="line">  <span class="attr">clean</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h2 id="8-2-生产环境配置"><a href="#8-2-生产环境配置" class="headerlink" title="8.2 生产环境配置"></a>8.2 生产环境配置</h2><p>思考生产环境的特点：</p>
<ul>
<li>mode - production （不再赘述）</li>
<li>移除 source-map （不再赘述）</li>
<li>压缩产物</li>
<li>移除 console.log 调试打印</li>
</ul>
<h3 id="8-2-1-压缩产物"><a href="#8-2-1-压缩产物" class="headerlink" title="8.2.1 压缩产物"></a>8.2.1 压缩产物</h3><p><strong>压缩 CSS</strong></p>
<p><a target="_blank" rel="noopener" href="https://webpack.js.org/plugins/mini-css-extract-plugin/#minimizing-for-production">https://webpack.js.org/plugins/mini-css-extract-plugin/#minimizing-for-production</a></p>
<p><a target="_blank" rel="noopener" href="https://webpack.js.org/plugins/css-minimizer-webpack-plugin/">https://webpack.js.org/plugins/css-minimizer-webpack-plugin/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm add -D css-minimizer-webpack-plugin</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; merge &#125; = <span class="built_in">require</span>(<span class="string">&#x27;webpack-merge&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> common = <span class="built_in">require</span>(<span class="string">&#x27;./webpack.common.js&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">CssMinimizerPlugin</span> = <span class="built_in">require</span>(<span class="string">&quot;css-minimizer-webpack-plugin&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title function_">merge</span>(common, &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">  <span class="attr">optimization</span>: &#123;</span><br><span class="line">    <span class="attr">minimizer</span>: [</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">CssMinimizerPlugin</span>(),</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><code>npm run build</code> 观察打包产物 CSS 文件尺寸，此时已被压缩。</p>
<p><strong>其他产物压缩</strong></p>
<p><a target="_blank" rel="noopener" href="https://webpack.js.org/plugins/terser-webpack-plugin/">https://webpack.js.org/plugins/terser-webpack-plugin/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm add -D terser-webpack-plugin</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">TerserPlugin</span> = <span class="built_in">require</span>(<span class="string">&quot;terser-webpack-plugin&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">optimization</span>: &#123;</span><br><span class="line">    <span class="attr">minimize</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">minimizer</span>: [<span class="keyword">new</span> <span class="title class_">TerserPlugin</span>()],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="8-2-2-移除调试输出语句"><a href="#8-2-2-移除调试输出语句" class="headerlink" title="8.2.2 移除调试输出语句"></a>8.2.2 移除调试输出语句</h3><p>第一个思路：使用插件及 webpack optimization 相关配置。大量插件配置简单，根据项目&#x2F;团队所需，可以区分移除 log&#x2F;info&#x2F;warn 等语句。</p>
<p>第二个思路：判断环境为 production，覆盖 window 下 console.log 方法，使其不输出打印内容。</p>
<p>两种方法各有优劣，需要按需选择，此处以上一节用于压缩的 TerserPlugin 为例，移除所有注释和打印语句。</p>
<p><a target="_blank" rel="noopener" href="https://github.sheincorp.cn/terser/terser#format-options">https://github.sheincorp.cn/terser/terser#format-options</a></p>
<p><a target="_blank" rel="noopener" href="https://github.sheincorp.cn/terser/terser#compress-options">https://github.sheincorp.cn/terser/terser#compress-options</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">optimization</span>: &#123;</span><br><span class="line">  <span class="attr">minimize</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">minimizer</span>: [</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">CssMinimizerPlugin</span>(),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">TerserPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">terserOptions</span>: &#123;</span><br><span class="line">        <span class="attr">compress</span>: &#123;</span><br><span class="line">          <span class="attr">drop_console</span>: <span class="literal">true</span>, <span class="comment">// 移除打印语句</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">format</span>: &#123;</span><br><span class="line">          <span class="attr">comments</span>: <span class="literal">false</span>, <span class="comment">// 移除注释</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h2 id="8-3-其他优化配置"><a href="#8-3-其他优化配置" class="headerlink" title="8.3 其他优化配置"></a>8.3 其他优化配置</h2><ul>
<li>使用 webpack-merge 来合并 开发 和 生产 环境的公共配置</li>
<li>通过 CDN 外部引入依赖，优势：<ul>
<li>利用 CDN 的速度优势 和 浏览器并发请求资源能力加速提升程序性能</li>
<li>抽离依赖，打包产物体积缩减</li>
</ul>
</li>
<li>多线程打包，发挥打包机器性能</li>
<li>treeShaking</li>
</ul>
<h3 id="8-3-1-配置合并"><a href="#8-3-1-配置合并" class="headerlink" title="8.3.1 配置合并"></a>8.3.1 配置合并</h3><ol>
<li>创建 <code>webpack.common.js</code> 用于存放公共配置，修改 config 命名为 prod，便于区分</li>
<li>分别删除 dev 和 prod 中的公共部分内容</li>
<li><code>pnpm install --save-dev webpack-merge</code></li>
<li>以生产打包配置举例，使用如下</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.prod.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; merge &#125; = <span class="built_in">require</span>(<span class="string">&#x27;webpack-merge&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> common = <span class="built_in">require</span>(<span class="string">&#x27;./webpack.common.js&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title function_">merge</span>(common, &#123;</span><br><span class="line">  <span class="attr">mode</span>: <span class="string">&#x27;production&#x27;</span>,</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.[jt]sx?$/</span>,</span><br><span class="line">        <span class="attr">exclude</span>: <span class="regexp">/node_modules/</span>,</span><br><span class="line">        <span class="attr">use</span>: <span class="string">&#x27;babel-loader&#x27;</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="8-3-2-外部-CDN-加载"><a href="#8-3-2-外部-CDN-加载" class="headerlink" title="8.3.2 外部 CDN 加载"></a>8.3.2 外部 CDN 加载</h3><p><a target="_blank" rel="noopener" href="https://webpack.js.org/configuration/externals/#root">https://webpack.js.org/configuration/externals/#root</a></p>
<p>可以简单的理解为 package.json 中 dependencies 依赖库，都可以通过 CDN 加载。</p>
<p>以 React 为例，需要考虑以下内容：</p>
<ol>
<li>依赖版本管理，从 package.json 转移到 index.ejs 中加载的 CDN 版本</li>
<li>dev.js 和 prod.min.js 在不同环境需要引入的 CDN 文件不同，可以通过定义两个 html 模板，在 HtmlWebpackPlugin 中，不同的环境选择不同的模板</li>
</ol>
<p>生产打包相关改动如下(开发类比，不再赘述)：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Fizzy React - Prod<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">body</span>,</span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">div</span>,</span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">p</span> &#123;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">margin</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">padding</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css">  </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">crossorigin</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/react@18/umd/react.production.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">crossorigin</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/react-dom@18/umd/react-dom.production.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; merge &#125; = <span class="built_in">require</span>(<span class="string">&#x27;webpack-merge&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> common = <span class="built_in">require</span>(<span class="string">&#x27;./webpack.common.js&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">HtmlWebpackPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;html-webpack-plugin&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title function_">merge</span>(common, &#123;</span><br><span class="line">  <span class="attr">mode</span>: <span class="string">&#x27;production&#x27;</span>,</span><br><span class="line">  <span class="attr">externals</span>: &#123; <span class="comment">// 此处放在 webpack.common.js 中</span></span><br><span class="line">    <span class="attr">react</span>: <span class="string">&#x27;window.React&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;react-dom&#x27;</span>: <span class="string">&#x27;window.ReactDOM&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;react-dom/client&#x27;</span>: <span class="string">&#x27;window.ReactDOM&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HtmlWebpackPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">template</span>: <span class="string">&#x27;template/prod.ejs&#x27;</span></span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>继续实践处理 react-router-dom@v6，发现产生引用 undefined，追踪报错位置发现，需要先引入 @remix-run&#x2F;router 和 react-router 才可以再引入 react-router-dom。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">externals</span>: &#123;</span><br><span class="line">  <span class="attr">react</span>: <span class="string">&#x27;React&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;react-dom&#x27;</span>: <span class="string">&#x27;ReactDOM&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;react-dom/client&#x27;</span>: <span class="string">&#x27;ReactDOM&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;@remix-run/router&#x27;</span>: <span class="string">&#x27;RemixRouter&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;react-router&#x27;</span>: <span class="string">&#x27;ReactRouter&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;react-router-dom&#x27;</span>: <span class="string">&#x27;ReactRouterDOM&#x27;</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">crossorigin</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/@remix-run/router@1.8.0/dist/router.umd.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">crossorigin</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/react-router@6.15.0/dist/umd/react-router.production.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">crossorigin</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/react-router-dom@6.15.0/dist/umd/react-router-dom.production.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/zzyxka/images/main/image-20230907140223991.png" alt="image-20230907140223991"></p>
<p>注意：<code>react-router-dom</code> 从 v6 开始，其 @types 由包本身导出，故此处若从 package.json 中移除依赖，会造成 ts 报错提示，安装 <code>@types/react-router-dom</code> 无用(版本低，缺少许多 hooks 的类型声明)，故应保留依赖。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cannot find module &#x27;react-router-dom&#x27; or its corresponding type declarations. ts(2307)</span><br></pre></td></tr></table></figure>

<h3 id="8-3-3-多线程打包"><a href="#8-3-3-多线程打包" class="headerlink" title="8.3.3 多线程打包"></a>8.3.3 多线程打包</h3><p><a target="_blank" rel="noopener" href="https://webpack.js.org/loaders/thread-loader/">https://webpack.js.org/loaders/thread-loader/</a></p>
<p>在 webpack@v4 前，有 happypack 的打包方案，后来 thread-loader 逐渐主流，配置较为简单，这里不再赘述。酌情使用，因为当项目较小时，该 loader 自身开销也需要 600ms，可能造成打包时间，不减反增的局面。</p>
<h3 id="8-3-4-treeShaking"><a href="#8-3-4-treeShaking" class="headerlink" title="8.3.4 treeShaking"></a>8.3.4 treeShaking</h3><p><a target="_blank" rel="noopener" href="https://webpack.js.org/guides/tree-shaking/">https://webpack.js.org/guides/tree-shaking/</a></p>
<p>“摇树”，作用是将没有被导入并使用的模块&#x2F;方法，干净的移除掉。</p>
<p>在 Webpack5 中，Tree Shaking 在生产环境下默认启动。</p>
<h1 id="9-扩展"><a href="#9-扩展" class="headerlink" title="9. 扩展"></a>9. 扩展</h1><p>扩展章节内容，均为“按需”内容，很多项目往往并不需要这些依赖。</p>
<h2 id="9-1-antd"><a href="#9-1-antd" class="headerlink" title="9.1 antd"></a>9.1 antd</h2><p><a target="_blank" rel="noopener" href="https://ant.design/docs/react/introduce-cn">https://ant.design/docs/react/introduce-cn</a></p>
<p>如果按照前文提到的 <code>externals</code> 方案，来引入 antd UI 库，应如下所述。</p>
<p>注意：</p>
<ol>
<li><p>根据指引，我们需要在引入 antd.[min].js 之前，引入 day.js 依赖</p>
</li>
<li><p>与 react-router-dom 一样</p>
<blockquote>
<p><code>antd</code> 使用 TypeScript 进行书写并提供了完整的定义文件。（不要引用 <code>@types/antd</code>）。</p>
</blockquote>
</li>
<li><p>模板头部引入 reset.css 用来初始化标签样式</p>
</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Fizzy React - Dev<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://unpkg.com/antd@5.9.1/dist/reset.css&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">crossorigin</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/react@18/umd/react.development.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">crossorigin</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/react-dom@18/umd/react-dom.development.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">crossorigin</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/@remix-run/router@1.8.0/dist/router.umd.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">crossorigin</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/react-router@6.15.0/dist/umd/react-router.development.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">crossorigin</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/react-router-dom@6.15.0/dist/umd/react-router-dom.development.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">crossorigin</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/dayjs@1.11.9/dayjs.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">crossorigin</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/antd@5.9.1/dist/antd.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">externals</span>: &#123;</span><br><span class="line">  <span class="attr">react</span>: <span class="string">&#x27;React&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;react-dom&#x27;</span>: <span class="string">&#x27;ReactDOM&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;react-dom/client&#x27;</span>: <span class="string">&#x27;ReactDOM&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;@remix-run/router&#x27;</span>: <span class="string">&#x27;RemixRouter&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;react-router&#x27;</span>: <span class="string">&#x27;ReactRouter&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;react-router-dom&#x27;</span>: <span class="string">&#x27;ReactRouterDOM&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;dayjs&#x27;</span>: <span class="string">&#x27;dayjs&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;antd&#x27;</span>: <span class="string">&#x27;antd&#x27;</span>,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>虽然这么用一切正常，但观察观察 devTools 可以发现，antd.min.js 即使是 min 也有 1.4MB 需要通过网络加载，它也不像 react 和 router 一样所有页面都会用到，它只会被某些页面用到，一次性全部加载显然不合适。</p>
<p>不妨放弃 externals，来使 antd 能够“按需引入”（默认支持），即：</p>
<ol>
<li>用到 Button 则只引入 Button</li>
<li>在进入实际使用该组件的页面时，才会加载 Button 的 “vendors-…-antd_es_button.js”</li>
</ol>
<h2 id="9-2-redux"><a href="#9-2-redux" class="headerlink" title="9.2 redux"></a>9.2 redux</h2><p><a target="_blank" rel="noopener" href="https://redux.js.org/">https://redux.js.org/</a></p>
<p>过去的各种状态管理方案层出不穷，redux 生态相关的方案也是如此。随着时间发展，redux-toolkit 成为官方正统，同样的 react-redux 也称为 react 项目状态管理的官方正统方案。接下来，我们使用二者来为项目引入 redux 状态管理能力。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm add @reduxjs/toolkit react-redux</span><br></pre></td></tr></table></figure>

<ol>
<li><p>创建 src&#x2F;store.ts 用于创建 store，并合并各个 slice reducer</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; configureStore &#125; <span class="keyword">from</span> <span class="string">&#x27;@reduxjs/toolkit&#x27;</span></span><br><span class="line"><span class="keyword">import</span> homeSlice <span class="keyword">from</span> <span class="string">&#x27;@/pages/home/reducer&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">configureStore</span>(&#123;</span><br><span class="line">  <span class="attr">reducer</span>: &#123;</span><br><span class="line">    <span class="attr">home</span>: homeSlice,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 entry.ts 入口处，使用 Provider 加载 store.ts 中创建的 sotre</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// entry.tsx</span></span><br><span class="line"><span class="comment">// import &quot;core-js&quot;;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createRoot &#125; <span class="keyword">from</span> <span class="string">&quot;react-dom/client&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&quot;./App&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&quot;./store&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Provider</span> &#125; <span class="keyword">from</span> <span class="string">&quot;react-redux&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rootElement = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;app&quot;</span>) ?? <span class="variable language_">document</span>.<span class="property">body</span>;</span><br><span class="line"><span class="keyword">const</span> root = <span class="title function_">createRoot</span>(rootElement);</span><br><span class="line">root.<span class="title function_">render</span>(</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">Provider</span> <span class="attr">store</span>=<span class="string">&#123;store&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">App</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">Provider</span>&gt;</span></span>,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
<li><p>在实际使用的页面&#x2F;模块中，创建 reducer.ts 来维护 reducer-slice，在视图层使用对应 reudx API 来 dispatch action 更新数据</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createSlice &#125; <span class="keyword">from</span> <span class="string">&#x27;@reduxjs/toolkit&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> homeSlice = <span class="title function_">createSlice</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;home&#x27;</span>,</span><br><span class="line">  <span class="attr">initialState</span>: &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="number">0</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">reducers</span>: &#123;</span><br><span class="line">    <span class="attr">increment</span>: <span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// Redux Toolkit allows us to write &quot;mutating&quot; logic in reducers. It</span></span><br><span class="line">      <span class="comment">// doesn&#x27;t actually mutate the state because it uses the Immer library,</span></span><br><span class="line">      <span class="comment">// which detects changes to a &quot;draft state&quot; and produces a brand new</span></span><br><span class="line">      <span class="comment">// immutable state based off those changes.</span></span><br><span class="line">      <span class="comment">// Also, no return statement is required from these functions.</span></span><br><span class="line">      state.<span class="property">value</span> += <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">decrement</span>: <span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</span><br><span class="line">      state.<span class="property">value</span> -= <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">incrementByAmount</span>: <span class="function">(<span class="params">state, action</span>) =&gt;</span> &#123;</span><br><span class="line">      state.<span class="property">value</span> += action.<span class="property">payload</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Action creators are generated for each case reducer function</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> &#123; increment, decrement, incrementByAmount &#125; = homeSlice.<span class="property">actions</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> homeSlice.<span class="property">reducer</span></span><br></pre></td></tr></table></figure>

<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/pages/home/Index.tsx</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useSelector, useDispatch &#125; <span class="keyword">from</span> <span class="string">&quot;react-redux&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; decrement, increment &#125; <span class="keyword">from</span> <span class="string">&quot;./reducer&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Counter</span>(<span class="params"></span>): <span class="title class_">React</span>.<span class="property">ReactElement</span>&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> count = <span class="title function_">useSelector</span>(<span class="function">(<span class="params">state</span>) =&gt;</span> state.<span class="property">home</span>.<span class="property">value</span>);</span><br><span class="line">  <span class="keyword">const</span> dispatch = <span class="title function_">useDispatch</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">aria-label</span>=<span class="string">&quot;Increment value&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> dispatch(increment())&#125;</span></span><br><span class="line"><span class="language-xml">        &gt;</span></span><br><span class="line"><span class="language-xml">          Increment</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;count&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">aria-label</span>=<span class="string">&quot;Decrement value&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> dispatch(decrement())&#125;</span></span><br><span class="line"><span class="language-xml">        &gt;</span></span><br><span class="line"><span class="language-xml">          Decrement</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Home</span>(<span class="params"></span>): <span class="title class_">React</span>.<span class="property">ReactElement</span>&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">textAlign:</span> &quot;<span class="attr">center</span>&quot; &#125;&#125;&gt;</span>Hello, Fizzy React!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Counter</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这里，已经能够使用 redux 管理状态，但并不是终点。为什么这么说？</p>
<ul>
<li><p>一方面，redux 的方案，类似 router 配置，我们还需要做自动引入和按需加载。</p>
</li>
<li><p>另一方面，redux 的理念很好，但是围绕状态管理，它并不是万金油。如果使用 redux 仅仅是为了把状态管理独立于视图代码外、避免层层组件传递，那么越来越多基于 hooks 的轻量框架已经足够完成（甚至只使用自定义 hooks 就可以满足）。</p>
</li>
</ul>
</li>
</ol>

      </div>
    </div>
  </section>
</article>
<!-- go-top -->
<a id="goTop" class="go-top" type="button">
  <svg t="1693380723883" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3999" width="20" height="20">
    <path d="M825.568 555.328l-287.392-289.28C531.808 259.648 523.488 256.576 515.2 256.64 514.08 256.544 513.12 256 512 256c-4.672 0-9.024 1.088-13.024 2.88-4.032 1.536-7.872 3.872-11.136 7.136l-259.328 258.88c-12.512 12.48-12.544 32.736-0.032 45.248 6.24 6.272 14.432 9.408 22.656 9.408 8.192 0 16.352-3.136 22.624-9.344L480 364.288 480 928c0 17.696 14.336 32 32 32s32-14.304 32-32L544 362.72l236.192 237.728c6.24 6.272 14.496 9.44 22.688 9.44s16.32-3.104 22.56-9.312C838.016 588.128 838.048 567.84 825.568 555.328zM864 192 160 192C142.336 192 128 177.664 128 160s14.336-32 32-32l704 0c17.696 0 32 14.336 32 32S881.696 192 864 192z" fill="#ffffff" p-id="4000"></path>
  </svg>
</a>
<script>
  goTop.addEventListener('click', function(e) {
    document.querySelector('.post-container').scrollTo({
      top: 0,
      left: 0,
      behavior: "smooth",
    });
  });
</script>
</body>

</html>